<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:h="http://java.sun.com/jsf/html" template="/layout/dialog.xhtml">

	
	<ui:define name="head">
		<script type="text/javascript" src="#{_ctx}/js/handlebars.runtime-v4.0.5.js"></script>
		<script type="text/javascript" src="#{_ctx}/js/templates/templates.js"></script>
		<style type="text/css">
			label:hover {
    background: #f2f5ff;
    border-radius:5px;
    padding:2px 4px;
}
		</style>
	
	</ui:define>
	
	<ui:define name="body">
		<input type="hidden" id="pageId" value="#{pageId}"/>
		<div style="margin-top: 20px; margin-right: 10px"
		class="locale-direction">
			
			<div>
					<button 
						class="w3-btn w3-large w3-circle w3-xlarge w3-ripple w3-teal w3-right" 
						id="createCurateBlockBtn"
					>+</button>
				<s:fragment rendered="#{identity.loggedIn}">
				</s:fragment>

				<script type="text/javascript">
					jQuery(window).load(function(){
						jQuery("#createCurateBlockBtn").popup({ content : "#{messages['Create_Block']}" });
					});

					jQuery(document).ready(function(){

						jQuery("#createCurateBlockBtn").click(function(){

							var pageId = jQuery("#pageId").val();
							jQuery.ajax(
									{
										type:"POST",
										url: "#{_ctx}/seam/resource/api/pages/blocks",
										data: JSON.stringify({ 'id': pageId }),
										contentType: "application/json; charset=utf-8",
										dataType: "json",
										success: function(data){																				
											var template = Handlebars.templates['pageBlocks'];
											var html  = template(data);											
											jQuery("#page_blocks").append(html);
										},
										failure: function(errMsg) {
											common.notification("#{messages['Error_Title']}", "errormsg");
									    }
									}
								);

						});

							
					});

					
					
				</script>
			</div>
			
			
			<div class="ui two cards" id="page_blocks">
			
				<c:forEach var="_item" items="#{pageHome.instance.blocks}">
  
				  <div class="card" id="block_#{_item.id}">
				    <div class="content">
				      <label class="pull-left" data-block-id="#{_item.id}" data-block-title="#{_item.title}">#{_item.title}</label>
					  <input class="clickedit" type="text" value="#{_item.title}"/>					  
				    </div>
				    <div class="extra">
						
				    </div>
				  </div>
				  
				</c:forEach>  
		    
 		   </div>
			
			
	</div>
	
	
	
	<script>
	//<![CDATA[
	var defaultText = 'Click me and enter some text';

	function endEdit(e) {
	    var input = jQuery(e.target),
	        label = input && input.prev();

	    var blockId = label.data('block-id');	    
	    var blockTitle = label.data('block-title');
	    if(blockTitle != input.val())
		{


	    	jQuery.ajax(
					{
						type:"PUT",
						url: "#{_ctx}/seam/resource/api/pages/blocks/"+blockId,
						data: JSON.stringify({ 'id': blockId, 'title':  input.val() }),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function(data){																				
							label.text(input.val() === '' ? defaultText : input.val());
						    input.hide();
						    label.show();
						},
						failure: function(errMsg) {
							common.notification("#{messages['Error_Title']}", "errormsg");
					    }
					}
				);

	    }
	    else
		{
	    	label.text(input.val() === '' ? defaultText : input.val());
		    input.hide();
		    label.show();
		}
		    
	    
		
	    
	}

	jQuery('.clickedit').hide()
	.focusout(endEdit)
	.keyup(function (e) {
	    if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
	        endEdit(e);
	        return false;
	    } else {
	        return true;
	    }
	})
	.prev().click(function () {
	    jQuery(this).hide();
	    jQuery(this).next().show().focus();
	});
	//]]>
	</script>
	
	
	
	

	</ui:define>
</ui:composition>
