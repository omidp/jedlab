<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:h="http://java.sun.com/jsf/html" template="/layout/layout.xhtml">

	
	<ui:define name="head">
		<script type="text/javascript" src="#{_ctx}/js/handlebars.runtime-v4.0.5.js"></script>
		<script type="text/javascript" src="#{_ctx}/js/templates/templates.js"></script>
		<style type="text/css">
			label:hover {
    background: #f2f5ff;
    border-radius:5px;
    padding:2px 4px;
}
		</style>
	
	</ui:define>
	
	<ui:define name="body">
		<input type="hidden" id="pageId" value="#{pageId}"/>
		<div style="margin-top: 20px; margin-right: 10px"
		class="locale-direction">
			
			<div>
					<button 
						class="w3-btn w3-large w3-circle w3-xlarge w3-ripple w3-teal w3-right" 
						id="createCurateBlockBtn"
					>+</button>
				<s:fragment rendered="#{identity.loggedIn}">
				</s:fragment>

				<script type="text/javascript">
					jQuery(window).load(function(){
						jQuery("#createCurateBlockBtn").popup({ content : "#{messages['Create_Block']}" });
					});

					jQuery(document).ready(function(){

						jQuery("#createCurateBlockBtn").click(function(){

							var pageId = jQuery("#pageId").val();
							jQuery.ajax(
									{
										type:"POST",
										url: "#{_ctx}/seam/resource/api/pages/blocks",
										data: JSON.stringify({ 'id': pageId }),
										contentType: "application/json; charset=utf-8",
										dataType: "json",
										success: function(data){																				
											var template = Handlebars.templates['pageBlocks'];
											var html  = template(data);											
											jQuery("#page_blocks").append(html);
											setUpClickEdit(data.id);
																				
										},
										failure: function(errMsg) {
											common.notification("#{messages['Error_Title']}", "errormsg");
									    }
									}
								);

						});

							
					});

					
					
				</script>
			</div>
			
			
			<div class="ui two cards" id="page_blocks">
			
				<c:forEach var="_item" items="#{pageHome.instance.blocks}">
  
				  <div class="card" id="block_#{_item.id}">
				    <div class="content">
				      <div class="left floated meta">				      	
				      </div>
				      <label class="pull-left" data-block-id="#{_item.id}" data-block-title="#{_item.title}">#{_item.title}</label>
					  <input class="clickedit #{_item.id}" type="text" value="#{_item.title}"/>					  
				    </div> 
				    <div class="content">
				    	<div class="ui ordered divided list" style="direction:ltr;" id="ul_#{_item.id}">
							<c:forEach var="_curate" items="#{_item.curates}">
									<a class="item" href="#{_curate.url}" target="_blank" data-curate-id="#{_curate.id}">#{_curate.titleOrUrl}</a>
							</c:forEach>
						</div>						
				    </div>
				    <div class="extra content">
				    	<div class="ui action input">
						  <input placeholder="#{messages['URL']}" type="text" id="curinp_#{_item.id}"/>
						  <button class="ui icon button addcur" id="curbtn_#{_item.id}" data-block-id="#{_item.id}" onclick="addCurate(#{_item.id})"> 
						    <i class="icon-plus"></i>
						  </button>
						</div>
				    </div>
				  </div>
				  
				</c:forEach>  
		    
 		   </div>
			
			
	</div>
	
	
	
	<script>
	//<![CDATA[
	var defaultText = 'Click me and enter some text';

	function endEdit(e) {
	    var input = jQuery(e.target),
	        label = input && input.prev();

	    var blockId = label.data('block-id');	    
	    var blockTitle = label.data('block-title');
	    if(blockTitle != input.val())
		{

	    	jQuery.ajax(
					{
						type:"PUT",
						url: "#{_ctx}/seam/resource/api/pages/blocks/"+blockId,
						data: JSON.stringify({ 'id': blockId, 'title':  input.val() }),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function(data){																				
						    
							label.text(input.val() === '' ? defaultText : input.val());
						    input.hide();
						    label.show();
						},
						failure: function(errMsg) {
							common.notification("#{messages['Error_Title']}", "errormsg");
					    }
					}
				);

	    }
	    else
		{
	    	label.text(input.val() === '' ? defaultText : input.val());
		    input.hide();
		    label.show();
		}
		    
	    
		
	    
	}

	jQuery(document).ready(function(){

		setUpClickEdit();
		
	});
	
function setUpClickEdit(data)
{
	var jq = '.clickedit';	
	if(typeof data != 'undefined')
		jq = '.clickedit.'+data;
	
	jQuery(jq).hide()
	.focusout(endEdit)
	.keyup(function (e) {
	    if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
	        endEdit(e);
	        return false;
	    } else {
	        return true;
	    }
	})
	.prev().click(function () {
	    jQuery(this).hide();
	    jQuery(this).next().show().focus();
	});
}


	
	//]]>
	</script>
	
	<script>
		function addCurate(bid)
		{

				var val = jQuery("#curinp_"+bid).val();

				jQuery.ajax(
						{
							type:"POST",
							url: "#{_ctx}/seam/resource/api/pages/curates",
							data: JSON.stringify({ "url": val, "pageBlock" :{"id":bid} }),
							contentType: "application/json; charset=utf-8",
							dataType: "json",
							success: function(data){																				
								var template = Handlebars.templates['curates'];
								var html  = template(data);											
								jQuery("#ul_"+bid).append(html);
								jQuery("#curinp_"+bid).val('');
							},
							failure: function(errMsg) {
								common.notification("#{messages['Error_Title']}", "errormsg");
						    }
						}
					);
				
		  		
				
			
		}

	  	


	</script>
	
	
	
	
	

	</ui:define>
</ui:composition>
