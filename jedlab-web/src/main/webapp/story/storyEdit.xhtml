<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jstl/core"
	template="/layout/layout.xhtml">

	<ui:define name="head">
		<script type="text/javascript" src="#{_ctx}/js/w2ui.js"></script>
		<link rel="stylesheet" type="text/css" href="#{_ctx}/css/w2ui.css" />
		<link href="#{_ctx}/css/materialize.css" rel="stylesheet" />  
		<link href="#{_ctx}/css/hjs.css" rel="stylesheet" />
		<style type="text/css">
			.writer-area{
				width: 100%;height: 100%;
			}
			.div-content{
				direction:rtl;font-family:SansPro, Yekan, Vazir-Light, Tahoma;
			}
			
			pre{
				direction:ltr !important;
			}
			code{
				direction:ltr !important;
			}
			[type="checkbox"]:not(:checked), [type="checkbox"]:checked {
			    left: 0;
			    opacity: 1;
			    position: relative;
			}
			
		</style>
	</ui:define>
	
	<ui:define name="body">   
		 
			<div
			class="w3-margin locale-direction">
				    
				        <input placeholder="#{messages['Title']}" type="text" style="width: 100%" id="storyTitle" maxlength="80"
				        	value="#{storyHome.instance.title}" 
				        	name="storyTitle"/>				        
				    <div class="form-item">				    	
				    	<s:fragment rendered="#{storyHome.instance.commentEnabled}">
					        <input type="checkbox" id="chkComp" checked="checked"  onchange="chkVal();"/>
				    	</s:fragment>
				    	<s:fragment rendered="#{!storyHome.instance.commentEnabled}">
					        <input type="checkbox" id="chkComp"  onchange="chkVal();"/>
				    	</s:fragment>
				        <input type="hidden" name="cmEnabled" id="cmEnabled"/>				        
				        <label>#{messages['Comment_Enabled']}</label>
				    </div>
				
				
					
					<script>
					
					
						function chkVal()
						{
							var v = jQuery("#chkComp").attr("checked");
							if(v == 'checked')
								jQuery("#cmEnabled").val("Y");
							else
								jQuery("#cmEnabled").val("N");
						}
					</script>
			
			</div>
			 
				<div id="layout" style="width: 100%; height: 90%;"></div>  

				<div id="mainContent" style="display:none;">
				
				<s:fragment rendered="#{storyHome.managed}">
					<textarea name="mdcontent" class="writer-area div-content mdcontent" >#{storyHome.markdownContent}</textarea>
				</s:fragment>
				
				<s:fragment rendered="#{!storyHome.managed}">
					<textarea name="mdcontent" class="writer-area div-content mdcontent" >## #{messages['JEDLog']}

#{messages['Default_Content_Story']}


```ceylon
shared void run() => newServer {
        Endpoint {
            path = startsWith("/");
            acceptMethod = { get };
            (request, response) =>
                response.writeString("Say more, more clearly");
        }
    }.start();
```

![alt text](http://jedlab.ir/images/logo.png "JEDLab Logo")

**#{messages['Story_Start_Now']}**
</textarea>
</s:fragment>
				</div>
				
				<div id="leftContent" style="display:none;">
					<div id="helperContent" class="div-content"></div>
				</div>
				
		
		<script type="text/javascript" src="#{_ctx}/js/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
		<h:form style="display:none;" id="storyForm">
			<input type="hidden" name="storyId" id="storyId" value="#{storyHome.instance.id}"/>
			<h:commandButton action="#{storyHome.removeByOwner()}" value="Del" id="btnStoryDel" />
		</h:form>
		
		
		<script type="text/javascript">
jQuery(function () {    
	var h = jQuery(window).height() - 100;
	jQuery("#layout").height(h);
    var pstyle = 'font-family:SansPro, Yekan, Vazir-Light, Tahoma; padding: 5px;background-color:#ffffff';
    jQuery('#layout').w2layout({
        name: 'layout',
        panels: [            
			 { type: 'top', size: 35, resizable: false, style: pstyle, content: '',
				 
				  toolbar: {
                    items: [
                        { type: 'button',  id: 'help', style: pstyle, caption: '#{messages.Story_Help}', img: 'icon-page' },
                        { type: 'break',  id: 'break0' },
                        { type: 'button',  id: 'preview', style: pstyle, caption: '#{messages.Preview}', img: 'icon-eye' },
                        { type: 'spacer' },
                        { type: 'button',  id: 'del', style: pstyle, caption: '#{messages.Delete}', img: 'icon-bin' },
                        { type: 'break',  id: 'break0' },
                        { type: 'button',  id: 'draft', style: pstyle, caption: '#{messages.Draft}', img: 'icon-pencil' },
                        { type: 'break',  id: 'break0' },
                        { type: 'button',  id: 'publish', style: pstyle, caption: '#{messages.Publish}', img: 'icon-database' }
                    ],
                    onClick: function (event) {                        
                        if(event.target == 'help')
                          window.open(window.location.origin + "#{_ctx}/story/markdownHelp.seam",'Markdown-Cheatsheet','height=750,width=550');
                        if(event.target == 'draft')  
                        	mdDraft();
						if(event.target == 'publish')  
							mdPublish();
						if(event.target == 'preview')
							mdPrv();
						if(event.target == 'del')
							jQuery("#storyForm\\:btnStoryDel").click();
                    }
                }
				 
				  },
            { type: 'left', style: pstyle, content: 'left', resizable: true },
            { type: 'main', style: pstyle, content: 'main' }
        ]
    });
            
});

jQuery(document).ready(function(){
		
		var w = jQuery(window).width();
		
		w2ui['layout'].set('left',{'size':w/2});
		w2ui['layout'].content('main',jQuery('#mainContent').html());
		w2ui['layout'].content('left',jQuery('#leftContent').html());
		jQuery("#mainContent").remove();
		//
		
		mdPrv();	  

			
	});

function mdPrv()
{
	jQuery.post("#{_ctx}/story/preview",
			{
				mdcontent: jQuery(".mdcontent").val()
			},
		function(data, status){			
			jQuery('#helperContent').html(data);	
			jQuery('pre code').each(function(i, block) {						
					hljs.highlightBlock(block);
				});		
				jQuery('span.rtl-dir').each(function(i, block) {						
					jQuery(this).parent().addClass('rtl-dir');
				});
				jQuery('span.ltr-dir').each(function(i, block) {						
					jQuery(this).parent().addClass('ltr-dir');
				});		
			});
}


function mdDraft()
{
	var t = jQuery("#storyTitle").val();
	if(t == '')
	{
		common.notification("#{messages['Empty_Title']}", "errormsg");
		return;
	}
	jQuery.post("#{_ctx}/story/draft",
			{
				mdcontent: jQuery(".mdcontent").val(),
				storyId: jQuery("#storyId").val(),
				storyTitle : jQuery("#storyTitle").val(),
				cmEnabled : jQuery("#cmEnabled").val()
			},
		function(data, status){	
			if(status == 'success')
			{
				common.notification("#{messages['Story_created']}", "infomsg");
				jQuery("#storyId").val(data);
			}	
			else				
			{
				common.notification("#{messages['Error_Title']}", "errormsg");
			}
		});
}

function mdPublish()
{
	var t = jQuery("#storyTitle").val();
	if(t == '')
	{
		common.notification("#{messages['Empty_Title']}", "errormsg");
		return;
	}
	jQuery.post("#{_ctx}/story/publish",
			{
				mdcontent: jQuery(".mdcontent").val(),
				storyId: jQuery("#storyId").val(),
				storyTitle : jQuery("#storyTitle").val(),
				cmEnabled : jQuery("#cmEnabled").val()
			},
		function(data, status){
				console.log(data);			
				if(status == 'success')
				{
					common.notification("#{messages['Story_created']}", "infomsg");
					jQuery("#storyId").val(data);
				}	
				else				
				{
					common.notification("#{messages['Error_Title']}", "errormsg");
				}			
		});
}


</script>
		

	</ui:define>
</ui:composition>
